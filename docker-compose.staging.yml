# Docker Compose overrides for staging environment
# Usage: docker compose -f docker-compose.yml -f docker-compose.prod.yml -f docker-compose.staging.yml --env-file .env.staging -p wop-staging up -d --build
# Ports: backend on 5011, frontend on 8081 (avoids collision with production)

services:
  db:
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-staging}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-staging}
      POSTGRES_DB: ${POSTGRES_DB:-writeorperish_staging}
    deploy:
      resources:
        limits:
          memory: 256M

  redis:
    deploy:
      resources:
        limits:
          memory: 128M

  backend:
    ports:
      - "127.0.0.1:5011:5010"
    # Override gunicorn to 2 workers (saves ~150 MiB vs prod's 4 workers)
    command: gunicorn --bind 0.0.0.0:5010 --workers 2 -k gevent --timeout 900 --access-logfile - --error-logfile - backend.app:app
    environment:
      - FLASK_ENV=staging
      - FRONTEND_URL=${FRONTEND_URL:-https://staging.loore.org}
    volumes:
      # Mount migrations from repo root (not in Docker build context)
      - ./migrations:/app/migrations
    deploy:
      resources:
        limits:
          memory: 512M

  celery:
    command: celery -A backend.celery_app.celery worker --loglevel=warning --concurrency=2
    deploy:
      resources:
        limits:
          memory: 512M

  celery-beat:
    command: celery -A backend.celery_app.celery beat --loglevel=warning
    deploy:
      resources:
        limits:
          memory: 128M

  frontend:
    # Use plain nginx with pre-built assets from CI (no Docker build needed)
    image: nginx:alpine
    ports:
      - "127.0.0.1:8081:80"
    volumes:
      - ./frontend/build-staging:/usr/share/nginx/html:ro
      - ./frontend/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    deploy:
      resources:
        limits:
          memory: 128M
